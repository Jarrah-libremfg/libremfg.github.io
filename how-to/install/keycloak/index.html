<!doctype html><html lang=en class="js csstransforms3d"><head><script></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:image" content="https://libremfg.github.io/images/rhize-logo.png"><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:site_name" content><meta property="og:url" content="https://libremfg.github.io/how-to/install/keycloak/"><meta property="og:locale" content="en"><meta name=generator content="Hugo 0.119.0"><meta name=description content="The Rhize GraphQL implementation uses OpenIDConnect for Authentication and role-based access control. This section describes how to set up Keycloak"><link rel=canonical href=https://libremfg.github.io/how-to/install/keycloak/><link rel=apple-touch-icon sizes=57x57 href=https://libremfg.github.io/images/favicons/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://libremfg.github.io/images/favicons/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://libremfg.github.io/images/favicons/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://libremfg.github.io/images/favicons/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://libremfg.github.io/images/favicons/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://libremfg.github.io/images/favicons/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://libremfg.github.io/images/favicons/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://libremfg.github.io/images/favicons/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://libremfg.github.io/images/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://libremfg.github.io/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://libremfg.github.io/images/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://libremfg.github.io/images/favicons/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://libremfg.github.io/images/favicons/favicon-16x16.png sizes=16x16><link rel=manifest href=https://libremfg.github.io/images/favicons/manifest.json><link rel=mask-icon href=https://libremfg.github.io/images/favicons/safari-pinned-tab.svg color=#fe2c06><link rel="shortcut icon" href=https://libremfg.github.io/images/favicons/favicon.ico><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/default.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js></script>
<script async src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/languages/go.min.js></script>
<script async src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/languages/java.min.js integrity="sha256-RyOs5MjQ+Ef9DQrPHp4QGr2tcNjxLh6mCkkW+sS4doU=" crossorigin=anonymous></script>
<script src=//code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.js integrity="sha256-x3BtPVERvw1ozPlwivuFLZoViFCeAAs1Gt6SxEedmo8=" crossorigin=anonymous></script>
<link href=//cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.css rel=stylesheet integrity="sha256-7sZe9dsqyNZC9Mk+WPRB7nVvPPPXyorzm2QKqlgXC4k=" crossorigin=anonymous><script async src=//cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/addon/edit/closebrackets.min.js integrity="sha256-qhu2a7DSpQaammMaLw1iruxBpxmgdw8mdQaQWQUokcY=" crossorigin=anonymous></script>
<script async src=//cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/javascript/javascript.min.js integrity="sha256-7Bdg/UdDMmHDPafpQDYZNPCEbnRP7eAvu+2hEoqRCXs=" crossorigin=anonymous></script><title>Authenticate with Keycloak - How to</title><link href=https://libremfg.github.io/css/theme.css?ba272c002d4ba1f22b16a4521475abf8 rel=stylesheet><link href=https://libremfg.github.io/css/runnable.css?46648956d99faa2e057d109b9f2a52e6 rel=stylesheet><link href=https://libremfg.github.io/css/tabs.css?035edc32762cb7973b740e3067101ced rel=stylesheet><link href=//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css rel=stylesheet integrity=sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ crossorigin=anonymous><script src=//cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js integrity=sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb crossorigin=anonymous></script>
<script src=//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js integrity=sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn crossorigin=anonymous></script>
<link href="//fonts.googleapis.com/css?family=Lato:400,700" rel=stylesheet><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link href=https://cdn.lineicons.com/2.0/LineIcons.css rel=stylesheet crossorigin=anonymous><link rel=stylesheet href=//cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body><nav id=header><div class=header-left><div><a href=https://libremfg.github.io/get-started/introduction class=brand><img src=https://libremfg.github.io/images/rhize-logo.png alt=RHIZE class=logo></a><div class=logo-tagline><span>Documentation</span></div></div></div><div class=header-right><div style=margin-top:10px><div class="menu-search align-middle"><div class=menu-search-inner><input type=search class="form-control form-control-sm" placeholder="Search documentation" aria-label="Search docs" autocomplete=off></div></div></div><div><ul class=menu><li><a href=https://libremfg.com/features-gql target=_blank>Home</a></li><li><a href=https://discord.gg/ZRpUBXmrkV target=_blank>Community</a></li><li><a href=https://github.com/libremfg/libremfg.github.io target=_blank>GitHub</a></li></ul></div></div><a href=# id=sidebar-toggle><i class="fa fa-bars"></i></a></nav><aside id=sidebar><div class=menu-header></div><ul class=topics><li class="topic main-topic children"><a id=get-started href=#>Get started</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/get-started/introduction/>What is Rhize?</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/get-started/how-rhize-works/>How Rhize works</a></li></ul></li><li class="topic main-topic children"><a id=concepts href=#>Concepts</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=#>DataHub</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/datahub/overview/>Overview</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/datahub/isa-95-data-model/>ISA 95 Data Model</a></li></ul></li><li class="topic sub-topic"><a href=#>Architecture</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/overview/>Overview</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/architecture/realtime-database/>Realtime Database</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/architecture/data-hub/>Data Hub Architecture</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/architecture/eda/>Event Driven Architecture</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/architecture/business-process-orchestration/>Business Process Orchestration</a></li></ul></li><li class="topic sub-topic"><a href=#>ISA 95</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/concepts/isa95/operationsevents/>Operations Events</a></li></ul></li></ul></li><li class="topic main-topic children active"><a id=how-to-guides href=#>How-to guides</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic active"><a href=#>Install</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic active"><a href=https://libremfg.github.io/how-to/install/keycloak/>Auth with Keycloak</a></li></ul></li><li class="topic sub-topic"><a href=#>Call the GraphQL API</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/how-to/query/default/>Use the @default Directive</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/how-to/query/generate/>The @generate Directive</a></li></ul></li><li class="topic sub-topic"><a href=https://libremfg.github.io/how-to/stream/>Stream Data</a></li></ul></li><li class="topic main-topic children"><a id=reference href=#>Reference</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/reference/directives/>Directives</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/reference/schema/>Schema</a></li><li class="topic sub-topic"><a href=#>BMPN elements</a><div class=arrow-down></div><ul class=sub-topics><li class="topic sub-topic"><a href=https://libremfg.github.io/reference/bpmn/events/>Events</a></li><li class="topic sub-topic"><a href=https://libremfg.github.io/reference/bpmn/activities/>Activities</a></li></ul></li><li class="topic sub-topic"><a href=https://libremfg.github.io/reference/glossary/>Glossary</a></li></ul></li><li class="topic main-topic"><a href=https://libremfg.github.io/releases/>Releases</a></li><li class="topic main-topic"><a href=https://libremfg.github.io/>Home</a></li></ul><ul class=sidebar-menu><li><a href=https://dgraph.io/ target=_blank>Home</a></li><li><a href=https://discuss.dgraph.io/ target=_blank>Community</a></li><li><a href=https://github.com/dgraph-io/dgraph target=_blank>GitHub</a></li></ul></aside></body></html><main class=content-wrapper><div class=content><div class=top-toc><nav id=TableOfContents><ul><li><a href=#overview-of-openidconnect>Overview of OpenIDConnect</a></li><li><a href=#set-up-keycloak>Set up Keycloak</a><ul><li><a href=#1-create-a-realm>1. Create a realm</a></li><li><a href=#2-create-a-client>2. Create a client</a></li><li><a href=#3-assign-permissions-to-the-client-system-account>3. Assign permissions to the client system account</a></li><li><a href=#4-configure-rhize-to-connect-to-the-keycloak-client>4. Configure Rhize to connect to the Keycloak client</a></li><li><a href=#5-check-the-client-roles>5. Check the client Roles</a></li><li><a href=#6-create-a-group>6. Create a group</a></li><li><a href=#7-assign-users-to-the-group>7. Assign users to the group</a></li><li><a href=#8-check-the-roles-in-the-token>8. Check the roles in the token</a></li></ul></li></ul></nav></div><article><a class=question-btn target=_blank href=https://discord.gg/ZRpUBXmrkV><i class="fa fa-question-circle"></i> Ask a Question</a><h1 class=post-title>Authenticate with Keycloak</h1><div><p>Rhize uses OpenIDConnect to connect to a Keycloak server to authenticate users and manage Role-based access controls.</p><h2 id=overview-of-openidconnect>Overview of OpenIDConnect</h2><p>Open ID Connect is a security architecture that uses JSON Web Tokens (JWTs) to access secured resources.
JWT are issued by KeyCloak, and the users can be managed in KeyCloak, or managed in other services like LDAP, Google, Azure AD, Facebook, etc.</p><p>When a user accesses the user interface, the UI redirects to Keycloak, which depending on how it is configured, will redirect to the authentication provider so that the user can log in. If the user is successfully authenticated, Keycloak will redirect back to the user interface with an authentication code in the url parameters.
The UI then calls a secure API to exchange the authentication code for a JWT.</p><p>The UI then uses that JWT to access secured API like the RHIZE GraphQL API.</p><p>The RHIZE DB has the public key from Keycloak, which can be used to verify the JWT.</p><pre class=mermaid>sequenceDiagram
	actor User
	participant UI as Web UI
	participant Rhize as RHIZE DB
	participant KC as KeyCloak
	participant AP as AuthProvider
	Rhize->>KC: Get Public Key
	User->>UI: Log In
	UI-->>KC: Redirect
	KC-->>AP: Redirect
	AP->>User: Credentials
	AP-->>KC: Auth Result
	KC-->>UI: Redirect with Code
	UI->>KC: Exchange Code for Token
	KC->>UI: Reply with id_token and access_token
	UI->>Rhize: Access API with Bearer Token
	Rhize->>Rhize: Verify Token with Public Key from Keycloak
</pre><h2 id=set-up-keycloak>Set up Keycloak</h2><p>The following sections step through how to set up Keycloak.</p><h3 id=1-create-a-realm>1. Create a realm</h3><p>Keycloak need to have a realm, which is like a tenant that contains all of the configuration.
Here we have created a realm named &ldquo;libre&rdquo;</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.39.15%20pm.png alt="Alt text"></p><h3 id=2-create-a-client>2. Create a client</h3><p>Once we have created a realm, we can go head and create a client for the database, and a client for the UI.</p><p>Here we have a client for the UI named libreUI, and a client for the database called libreBaas</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.41.00%20pm.png alt="Alt text"></p><p>The LibreBaas client should be configured like this:</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.43.51%20pm.png alt="Alt text"></p><h3 id=3-assign-permissions-to-the-client-system-account>3. Assign permissions to the client system account</h3><p>We need to assign permissions to the service account in the client so that the Rhize DB can create roles</p><p>Add these roles to the service account in the libreBaas client</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.45.47%20pm.png alt="Alt text"></p><h3 id=4-configure-rhize-to-connect-to-the-keycloak-client>4. Configure Rhize to connect to the Keycloak client</h3><p>Whe you start Rhize, you provide the credentials to your OIDC server in the startup flags like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>alpha --my=0.0.0.0:7080 --zero=0.0.0.0:5080 --security whitelist=0.0.0.0/0 --graphql debug=true --cdc nats=<span style=color:#a31515>&#34;nats://system:system@localhost:4222&#34;</span> --oidc bypass=false;url=http://localhost:8090;realm=libre;client-id=libreBaas;client-secret=pk98t8jVtwF9P8erRHZpLklWtz1TzGTR;scopemap=./scopemap.json
</span></span></code></pre></div><p>The <code>--oidc</code> flag has the following sub-flags:</p><ul><li><p><code>bypass=false</code> This flag allows you to bypass security completely to help you get started quickly. To bypass security, set this to true. The server will then not try to validate your access token.</p></li><li><p><code>url=http://localhost:8090</code> This is the url of the keycloak server</p></li><li><p><code>realm=libre</code> The realm within the Keycloak server that holds your users, groups and clients</p></li><li><p><code>client-id=libreBaas</code> The name of the client within Keycloak</p></li><li><p><code>client-secret=YourSecretHere</code> The secret to use to access the client in KeyCloak</p></li><li><p><code>scopemap=./scopemap</code>. The path to your ScopeMap, an example JSON file that maps client roles in KeyCloak to types in the schema.</p><p>For example, this scopemap provides the <code>libre</code> role access to the listed types in the schema:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	&#34;libre&#34;: [
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;AccessPermission&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;Comment&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;EnvironmentalVariable&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;EnvironmentalVariableVersion&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;HierarchyScope&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;LibreService&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;Menu&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;Secret&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;SecretVersion&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;Signature&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a31515>&#34;SignatureReason&#34;</span>
</span></span><span style=display:flex><span>	]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><h3 id=5-check-the-client-roles>5. Check the client Roles</h3><p>When Rhize starts up and receives the schema, it connects to Keycloak and creates client roles in the libreBaas client for each of the roles in the scopeMap, adding the operation type as shown below:</p><p><img src=https://libremfg.github.io/images/graphql/KeyCloakClientRoles.png alt="Keycloak Client Roles"></p><h3 id=6-create-a-group>6. Create a group</h3><p>We will need a group to act as a collection of the client roles that users should be granted. Here we will create an Admin group that has all of the client roles</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.48.02%20pm.png alt="Alt text"></p><p>Map the client roles from the libreBaas client into the group.</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.49.23%20pm.png alt="Alt text"></p><h3 id=7-assign-users-to-the-group>7. Assign users to the group</h3><p>Add a user, and assign them to the group. Here we have added a username
<img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.51.59%20pm.png alt="Alt text"></p><h3 id=8-check-the-roles-in-the-token>8. Check the roles in the token</h3><p>We can check our configuration by generating an access token from the libreBaas client.
Select the user you created, and click on <code>Generate access token</code></p><p>We want to see that the roles that we mapped into the group that the user is a member of show in the token under resource_access.libreBaas.roles like this:</p><p><img src=https://libremfg.github.io/images/graphql/Screenshot%202023-08-12%20at%205.53.38%20pm.png alt="Alt text"></p></div><div class=post__comments><footer class=clearfix><a class=question-btn target=_blank href=https://discord.gg/ZRpUBXmrkV><i class="fa fa-question-circle"></i> Ask a Question</a>
<a class=edit-btn target=_blank href=https://github.com/libremfg/libremfg.github.io/edit/main/content/how-to/install/keycloak.md><i class="fa fa-github-alt"></i> Edit Page</a></footer></div><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script></article><div class=right-toc><nav id=TableOfContents><ul><li><a href=#overview-of-openidconnect>Overview of OpenIDConnect</a></li><li><a href=#set-up-keycloak>Set up Keycloak</a><ul><li><a href=#1-create-a-realm>1. Create a realm</a></li><li><a href=#2-create-a-client>2. Create a client</a></li><li><a href=#3-assign-permissions-to-the-client-system-account>3. Assign permissions to the client system account</a></li><li><a href=#4-configure-rhize-to-connect-to-the-keycloak-client>4. Configure Rhize to connect to the Keycloak client</a></li><li><a href=#5-check-the-client-roles>5. Check the client Roles</a></li><li><a href=#6-create-a-group>6. Create a group</a></li><li><a href=#7-assign-users-to-the-group>7. Assign users to the group</a></li><li><a href=#8-check-the-roles-in-the-token>8. Check the roles in the token</a></li></ul></li></ul></nav></div></div></main><div class="modal fade" id=runnable-modal tabindex=-1 role=dialog aria-labelledby=exampleModalLabel aria-hidden=true><a href=# data-dismiss=modal class=modal-close-btn>Close</a><div class=modal-dialog role=document><div class=modal-content><div class=modal-body></div></div></div></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script>
<script type=text/javascript>if(window.docsearch){var version="latest",path=window.location.pathname,arr=/(?:\/)?((?:master)|(?:v[0-9][^/]+))(?:\/)?.*$/.exec(path);arr!=null&&arr.length>1&&(version=arr[1]),window.docsearch({apiKey:"fe4cbc1640c6c87bbc5f099902d86f97",indexName:"dgraph",inputSelector:"#algolia-doc-search",algoliaOptions:{filters:`version:${version}`},debug:!1})}</script><script type=text/javascript>adroll_adv_id="L42C3U2UXBBPVAMISVXVLC",adroll_pix_id="MOR4VUNPK5B2LHEZ2NNTDX",adroll_version="2.0",function(e,t,n,s,o){e.__adroll_loaded=!0,e.adroll=e.adroll||[],e.adroll.f=["setProperties","identify","track"];var i="https://s.adroll.com/j/"+adroll_adv_id+"/roundtrip.js";for(o=0;o<e.adroll.f.length;o++)e.adroll[e.adroll.f[o]]=e.adroll[e.adroll.f[o]]||function(t){return function(){e.adroll.push([t,arguments])}}(e.adroll.f[o]);n=t.createElement("script"),s=t.getElementsByTagName("script")[0],n.async=1,n.src=i,s.parentNode.insertBefore(n,s)}(window,document),adroll.track("pageView")</script><script src=https://libremfg.github.io/js/clipboard.min.js></script>
<script src=https://libremfg.github.io/js/dgraph.js?a9873668f1334ff6c49d4edea0a4bc38></script>
<script src=https://libremfg.github.io/js/runnable.js?6e7f328df4134d18ba5c8dd11f84deb8></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>